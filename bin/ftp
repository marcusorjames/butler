#!/bin/bash
# sftp

set -euo pipefail
trap 'echo "Error: Script failed at line $LINENO."; exit 1' ERR

PACKAGE="butler sftp"
DIR="$DIR/bin"
COMMON=$DIR/common

. "$COMMON/absolute_path.sh"

# Defaults
UPLOAD_PATH="$HOME/ftp"
EXTERNAL_PORT="20-21"
PASSWORD=""
HELP=false

# Helper to fetch the next argument safely
require_arg() {
  local opt="$1"
  local val="${2:-}"
  if [[ -z "$val" || "$val" =~ ^- ]]; then
    echo "Error: Missing value for $opt" >&2
    echo "Try '$(basename "$0") --help' for usage." >&2
    exit 1
  fi
  echo "$val"
}

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    -k|--key)
      KEY_PATH=$(require_arg "$1" "${2-}")
      shift 2
      ;;
    -u|--upload)
      UPLOAD_PATH=$(require_arg "$1" "${2-}")
      shift 2
      ;;
    -p|--port)
      EXTERNAL_PORT=$(require_arg "$1" "${2-}")
      shift 2
      ;;
    -P|--password)
      if [[ $# -ge 2 && ! "$2" =~ ^- ]]; then
        PASSWORD="$2"
        shift 2
      else
        read -s -p "Password: " PASSWORD
        echo ""
        shift
      fi
      ;;
    -h|--help)
      HELP=true
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Try '$(basename "$0") --help' for usage." >&2
      exit 1
      ;;
  esac
done

print_usage() {
  echo ""
  echo "Run an ephemeral FTP server"
  echo ""
  echo "USAGE:"
  echo "  $(basename "$0") [options]"
  echo ""
  echo "OPTIONS:"
  echo "  -u, --upload PATH     Upload directory (default: \$HOME/ftp)"
  echo "  -P, --port PORT       External port to expose (default: 2222)"
  echo "  -w, --password PASS   Password for SFTP user (empty for key-only)"
  echo "  -h, --help            Show this help message"
  echo ""
  echo "NOTES:"
  echo "  - If no valid key path is found, the container runs password-only."
  echo "  - Press Ctrl+C to stop; container is removed automatically."
  echo ""
}

$HELP && print_usage && exit 0

# Validate upload dir
mkdir -p "$UPLOAD_PATH"

# Ensure paths are absolute
UPLOAD_PATH=$(absolute_path "$UPLOAD_PATH")

# Run container
echo "Starting FTP server..."
echo "  Upload Path:  $UPLOAD_PATH"
echo "  Port:         $EXTERNAL_PORT"
echo "  Password:     ${PASSWORD:+<set>}${PASSWORD:+" (hidden)"}"
echo ""
echo "------------------------------------------------------------"
echo "Server Started (press Ctrl+C to stop)"
echo "------------------------------------------------------------"
echo ""

docker network inspect ftp >/dev/null 2>&1 || docker network create ftp

docker run -it --rm --init \
	--env FTP_PASS="${PASSWORD}" \
	--env FTP_USER=user \
	--name ftp-server \
	--publish "${EXTERNAL_PORT}:20-21/tcp" \
	--publish 40000-40009:40000-40009/tcp \
	--volume "${UPLOAD_PATH}:/home/user" \
    --name ftp \
    --network ftp \
	garethflowers/ftp-server
