#!/bin/sh
# Docker compose passthrough

PACKAGE="butler docker-compose"

DIR="$DIR/bin"
COMMON=$DIR/common

. $COMMON/colours.sh
. $COMMON/functions.sh

print_usage() {
  echo "Docker Compose passthrough"
  echo " "
  echo "SYNOPSIS:"
  echo " "
  echo "$PACKAGE COMMAND... [options]"
  echo ""
  echo "COMMAND / Options:"
  echo "See --help inherited from docker-compose"
}

[ ! "$#" -gt 0 ] && print_usage && exit 1

cmd="$1"
site="$2"

if ! site_dir="$(get_site_dir "$site")"; then
  die_with_error "Site ${CWarn}$site${Color_Off} doesn't exist"
fi

shift 2

# Ensure we are not in a docker directory as this breaks --project-directory
# docker-compose commands!
cd $DIR

# Ensure nginx-proxy is up
[ ! "$(docker ps | grep nginx-proxy)" ] && docker compose \
    --project-directory "$DIR/../common/nginx-proxy" up -d

# Run any site scripts
if [ -f "$site_dir/scripts/$cmd" ]; then
  . "$site_dir/scripts/$cmd"
fi

docker compose --project-directory $site_dir $cmd "$@"
